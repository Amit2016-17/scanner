<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>scannerpy.op &#8212; Scanner 0.2.22 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/styles/atelier-cave-light.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

  </head><body>
<a href="https://github.com/scanner-research/scanner" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0; z-index: 1;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


 <div id="navbar" class="navbar navbar-scanner ">
    <div class="container navbar-container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/scanner_logo.png"></span>
           </a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../guide.html" class="navbar-link">Guide</a></li>
                <li><a href="../../api.html" class="navbar-link">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for scannerpy.op</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">scannerpy.common</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scannerpy.protobuf_generator</span> <span class="k">import</span> <span class="n">python_to_proto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">islice</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>


<div class="viewcode-block" id="OpColumn"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn">[docs]</a><span class="k">class</span> <span class="nc">OpColumn</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="OpColumn.compress"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">codecs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;video&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_video</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_default</span><span class="p">,</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossless</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">codec</span> <span class="ow">in</span> <span class="n">codecs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="p">[</span><span class="n">codec</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression codec </span><span class="si">{}</span><span class="s1"> not currently &#39;</span>
                                   <span class="s1">&#39;supported. Available codecs are: </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span></div>

<div class="viewcode-block" id="OpColumn.compress_video"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_video">[docs]</a>    <span class="k">def</span> <span class="nf">compress_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quality</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keyframe_distance</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;h264&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="n">quality</span><span class="p">,</span>
            <span class="s1">&#39;bitrate&#39;</span><span class="p">:</span> <span class="n">bitrate</span><span class="p">,</span>
            <span class="s1">&#39;keyframe_distance&#39;</span><span class="p">:</span> <span class="n">keyframe_distance</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.lossless"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.lossless">[docs]</a>    <span class="k">def</span> <span class="nf">lossless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;raw&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpColumn.compress_default"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpColumn.compress_default">[docs]</a>    <span class="k">def</span> <span class="nf">compress_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_is_video</span><span class="p">()</span>
        <span class="n">encode_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_compressed_column</span><span class="p">(</span><span class="n">encode_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_assert_is_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Compression only supported for columns of&#39;</span>
                                   <span class="s1">&#39;type &quot;video&quot;. Column </span><span class="si">{}</span><span class="s1"> type is </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">ColumnType</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_new_compressed_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encode_options</span><span class="p">):</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
        <span class="n">new_col</span><span class="o">.</span><span class="n">_encode_options</span> <span class="o">=</span> <span class="n">encode_options</span>
        <span class="k">return</span> <span class="n">new_col</span></div>


<span class="n">PYTHON_OP_REGISTRY</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="OpGenerator"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.OpGenerator">[docs]</a><span class="k">class</span> <span class="nc">OpGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates Op instances to define a computation.</span>

<span class="sd">    When a particular op is requested from the generator, e.g.</span>
<span class="sd">    `db.ops.Histogram`, the generator does a dynamic lookup for the</span>
<span class="sd">    op in a C++ registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Check python registry for Op</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="n">py_op_info</span> <span class="o">=</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># If Op has not been registered yet, register it</span>
            <span class="n">pseudo_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;registration_id&#39;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pseudo_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">]:</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_sets&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;device_sets&#39;</span><span class="p">]:</span>
                        <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">register_op</span><span class="p">(</span>
                    <span class="n">pseudo_name</span><span class="p">,</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;input_columns&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;output_columns&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;variadic_inputs&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;stencil&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;unbounded_state&#39;</span><span class="p">],</span>
                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">],</span> <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;proto_path&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">register_python_kernel</span><span class="p">(</span><span class="n">pseudo_name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
                                                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">],</span>
                                                    <span class="n">py_op_info</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">])</span>

        <span class="c1"># This will raise an exception if the op does not exist.</span>
        <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">op_info</span><span class="o">.</span><span class="n">variadic_inputs</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">op_info</span><span class="o">.</span><span class="n">input_columns</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;Op </span><span class="si">{}</span><span class="s1"> required column </span><span class="si">{}</span><span class="s1"> as input&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bounded_state</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;bounded_state&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">stencil</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;stencil&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extra&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">Op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">bounded_state</span><span class="p">,</span>
                    <span class="n">stencil</span><span class="p">,</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_op</span></div>


<div class="viewcode-block" id="Op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op">[docs]</a><span class="k">class</span> <span class="nc">Op</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">db</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">inputs</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">,</span>
                 <span class="n">batch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">warmup</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">stencil</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span> <span class="o">=</span> <span class="n">warmup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span> <span class="o">=</span> <span class="n">stencil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">extra</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Space&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Sample&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Slice&#39;</span>
                <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Unslice&#39;</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OpColumn</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_col</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_output_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">OpColumn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="n">outputs</span>

<div class="viewcode-block" id="Op.inputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.inputs">[docs]</a>    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span></div>

<div class="viewcode-block" id="Op.outputs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.outputs">[docs]</a>    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Op.to_proto"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.Op.to_proto">[docs]</a>    <span class="k">def</span> <span class="nf">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Op</span><span class="p">()</span>
        <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">e</span><span class="o">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">stencil</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stencil</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>
        <span class="n">e</span><span class="o">.</span><span class="n">warmup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warmup</span>

        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Input&quot;</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_col</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">_op</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">_col</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># To convert an arguments dict, we search for a protobuf with the</span>
                <span class="c1"># name {Op}Args (e.g. BlurArgs, HistogramArgs) in the</span>
                <span class="c1"># args.proto module, and fill that in with keys from the args dict.</span>
                <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">proto_name</span> <span class="o">=</span> <span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">python_to_proto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span>
                                                    <span class="n">proto_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If arguments are a protobuf object, serialize it directly</span>
            <span class="n">e</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="register_python_op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.op.register_python_op">[docs]</a><span class="k">def</span> <span class="nf">register_python_op</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">stencil</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">unbounded_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">bounded_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">device_type</span><span class="p">:</span> <span class="n">DeviceType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">device_sets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DeviceType</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class or function decorator which registers a new Op and Kernel with the</span>
<span class="sd">    Scanner master.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name</span>
<span class="sd">      Optional name for the Op. By default, it will be inferred as the name of the</span>
<span class="sd">      decorated class/kernel.</span>

<span class="sd">    stencil</span>
<span class="sd">      Specifies the default stencil to use for the Op. If none, indicates</span>
<span class="sd">      that the the Op does not have the ability to stencil. A stencil of</span>
<span class="sd">      [0] should be specified if the Op can stencil but should not by</span>
<span class="sd">      default.</span>

<span class="sd">    unbounded_state</span>
<span class="sd">      If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">      of its input sequences before it can compute a given element. For</span>
<span class="sd">      example, to compute output element at index 100, the Op must have</span>
<span class="sd">      already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">      with `bounded_state`.</span>

<span class="sd">    bounded_state</span>
<span class="sd">      If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">      of its input sequences before it can compute a given element. For</span>
<span class="sd">      example, to compute output element at index 100, the Op must have</span>
<span class="sd">      already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">      with `bounded_state`.</span>

<span class="sd">    device_type</span>

<span class="sd">    device_sets</span>

<span class="sd">    batch</span>

<span class="sd">    proto_path</span>
<span class="sd">      Optional path to the proto file that describes the configuration</span>
<span class="sd">      arguments to this Op.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">):</span>
        <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">fn_or_class</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">):</span>
            <span class="n">is_fn</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Infer name from fn_or_class name</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kname</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">can_stencil</span> <span class="o">=</span> <span class="n">stencil</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">can_batch</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Get execute function to determine input and output types</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="n">fn_or_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exec_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Attempted to register Python Op with name </span><span class="si">{:s}</span><span class="s1">, but that &#39;</span>
                     <span class="s1">&#39;provided class has no &quot;execute&quot; method.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">)</span>

        <span class="n">fn_params</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="c1"># If this is a fn kernel, then the first argument should be `config`</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If this is a class kernel, then first argument should be self</span>
            <span class="n">fn_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">can_batch</span><span class="p">:</span>
                <span class="c1"># If the op can batch, then we expect the types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A batched Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input and output.&#39;</span><span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_input</span> <span class="ow">and</span> <span class="n">can_stencil</span><span class="p">:</span>
                <span class="c1"># If the op can stencil, then we expect the input types to be</span>
                <span class="c1"># Sequence[T], where T = {bytes, FrameType}</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">typ</span><span class="o">.</span><span class="n">__origin__</span> <span class="o">!=</span> <span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;A stenciled Op must specify a &quot;Sequence&quot; type &#39;</span>
                         <span class="s1">&#39;annotation for each input. If the Op both stencils &#39;</span>
                         <span class="s1">&#39;and batches, then it should have the type &#39;</span>
                         <span class="s1">&#39;&quot;Sequence[Sequence[T]], where T = {bytes, FrameType}.&#39;</span>
                         <span class="p">))</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Blob</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">FrameType</span><span class="p">:</span>
                <span class="n">column_type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">Video</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Invalid type annotation specified for input </span><span class="si">{:s}</span><span class="s1">. Must &#39;</span>
                     <span class="s1">&#39;specify an annotation of type &quot;bytes&quot; or &#39;</span>
                     <span class="s1">&#39;&quot;FrameType&quot;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">column_type</span>

        <span class="c1"># Analyze exec_fn parameters to determine the input types</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fn_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We only allow keyword arguments and *args.</span>
            <span class="c1"># There is no support currently for positional or **kwargs</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;Positional arguments and **kwargs are currently not &#39;</span>
                     <span class="s1">&#39;supported for the &quot;execute&quot; method of kernels&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="c1"># This means we have variadic inputs</span>
                <span class="n">has_variadic_inputs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;Variadic positional inputs (*args) are not supported &#39;</span>
                         <span class="s1">&#39;when used with other inputs.&#39;</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;No type annotation specified for input </span><span class="si">{:s}</span><span class="s1">. Must &#39;</span>
                     <span class="s1">&#39;specify an annotation of &quot;bytes&quot; or &quot;FrameType&quot;.&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param_name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">))</span>

        <span class="n">output_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Analyze exec_fn return type to determine output types</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="n">sig</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Return annotation must be specified for &quot;execute&quot; method.&#39;</span><span class="p">))</span>

        <span class="n">return_is_tuple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__origin__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">Tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__tuple_params__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Python 3.5</span>
                <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_use_ellipsis__</span>
                <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__tuple_params__</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s1">&#39;__args__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Python 3.6+</span>
                <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">Ellipsis</span>
                <span class="n">tuple_params</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">use_ellipsis</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;This should not happen...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_ellipsis</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">return_is_tuple</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">tuple_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">typ</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_ellipsis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Ellipsis tuples not supported for return type.&#39;</span><span class="p">))</span>

        <span class="c1"># Parse the return types into Scanner column types</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tuple_params</span><span class="p">):</span>
            <span class="n">column_type</span> <span class="o">=</span> <span class="n">parse_annotation_to_column_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">output_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ret</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">column_type</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kname</span> <span class="ow">in</span> <span class="n">PYTHON_OP_REGISTRY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Attempted to register Op with name </span><span class="si">{:s}</span><span class="s1"> twice&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kname</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">parse_ret</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">return_is_tuple</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">)</span>

        <span class="c1"># Wrap exec_fn to destructure input and outputs to proper python inputs</span>
        <span class="k">if</span> <span class="n">is_fn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn_or_class</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">wrapper_exec</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                        <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>
            <span class="n">wrapped_fn_or_class</span> <span class="o">=</span> <span class="n">wrapper_exec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapped_fn_or_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Kernel&#39;</span><span class="p">,</span> <span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">,</span>
                                       <span class="nb">dict</span><span class="p">(</span><span class="n">fn_or_class</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">has_variadic_inputs</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">in_cols</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_cols</span><span class="p">):</span>
                        <span class="n">args</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">return</span> <span class="n">parse_ret</span><span class="p">(</span><span class="n">exec_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>
            <span class="n">wrapped_fn_or_class</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">execute</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">device_type</span>
        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">device_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">CPU</span>

        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">device_sets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Must only specify one of &quot;device_type&quot; or &quot;device_sets&quot; for python Op.&#39;</span><span class="p">)</span>
            
        <span class="n">PYTHON_OP_REGISTRY</span><span class="p">[</span><span class="n">kname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_columns&#39;</span><span class="p">:</span> <span class="n">input_columns</span><span class="p">,</span>
            <span class="s1">&#39;output_columns&#39;</span><span class="p">:</span> <span class="n">output_columns</span><span class="p">,</span>
            <span class="s1">&#39;variadic_inputs&#39;</span><span class="p">:</span> <span class="n">has_variadic_inputs</span><span class="p">,</span>
            <span class="s1">&#39;stencil&#39;</span><span class="p">:</span> <span class="n">stencil</span><span class="p">,</span>
            <span class="s1">&#39;unbounded_state&#39;</span><span class="p">:</span> <span class="n">unbounded_state</span><span class="p">,</span>
            <span class="s1">&#39;bounded_state&#39;</span><span class="p">:</span> <span class="n">bounded_state</span><span class="p">,</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="n">wrapped_fn_or_class</span><span class="p">,</span>
            <span class="s1">&#39;device_type&#39;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
            <span class="s1">&#39;device_sets&#39;</span><span class="p">:</span> <span class="n">device_sets</span><span class="p">,</span>
            <span class="s1">&#39;batch&#39;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
            <span class="s1">&#39;proto_path&#39;</span><span class="p">:</span> <span class="n">proto_path</span><span class="p">,</span>
            <span class="s1">&#39;registration_id&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fn_or_class</span>

    <span class="k">return</span> <span class="n">dec</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, Alex Poms, Will Crichton.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>
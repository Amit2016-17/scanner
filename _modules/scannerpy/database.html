
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>scannerpy.database &#8212; Scanner 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scanner 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for scannerpy.database</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux2&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">prctl</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">ascii_uppercase</span>

<span class="kn">from</span> <span class="nn">scannerpy.common</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scannerpy.profiler</span> <span class="k">import</span> <span class="n">Profiler</span>
<span class="kn">from</span> <span class="nn">scannerpy.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">scannerpy.op</span> <span class="k">import</span> <span class="n">OpGenerator</span><span class="p">,</span> <span class="n">Op</span><span class="p">,</span> <span class="n">OpColumn</span>
<span class="kn">from</span> <span class="nn">scannerpy.source</span> <span class="k">import</span> <span class="n">SourceGenerator</span><span class="p">,</span> <span class="n">Source</span>
<span class="kn">from</span> <span class="nn">scannerpy.sink</span> <span class="k">import</span> <span class="n">SinkGenerator</span><span class="p">,</span> <span class="n">Sink</span>
<span class="kn">from</span> <span class="nn">scannerpy.streams</span> <span class="k">import</span> <span class="n">StreamsGenerator</span>
<span class="kn">from</span> <span class="nn">scannerpy.partitioner</span> <span class="k">import</span> <span class="n">TaskPartitioner</span>
<span class="kn">from</span> <span class="nn">scannerpy.table</span> <span class="k">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">scannerpy.column</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">scannerpy.protobuf_generator</span> <span class="k">import</span> <span class="n">ProtobufGenerator</span><span class="p">,</span> <span class="n">python_to_proto</span>
<span class="kn">from</span> <span class="nn">scannerpy.job</span> <span class="k">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">scannerpy.kernel</span> <span class="k">import</span> <span class="n">Kernel</span>

<span class="kn">from</span> <span class="nn">storehouse</span> <span class="k">import</span> <span class="n">StorageConfig</span><span class="p">,</span> <span class="n">StorageBackend</span>

<span class="kn">import</span> <span class="nn">scannerpy._python</span> <span class="k">as</span> <span class="nn">bindings</span>
<span class="kn">import</span> <span class="nn">scanner.metadata_pb2</span> <span class="k">as</span> <span class="nn">metadata_types</span>
<span class="kn">import</span> <span class="nn">scanner.engine.rpc_pb2</span> <span class="k">as</span> <span class="nn">rpc_types</span>
<span class="kn">import</span> <span class="nn">scanner.engine.rpc_pb2_grpc</span> <span class="k">as</span> <span class="nn">grpc_types</span>
<span class="kn">import</span> <span class="nn">scanner.types_pb2</span> <span class="k">as</span> <span class="nn">misc_types</span>

<span class="n">SCRIPT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Entrypoint for all Scanner operations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    master</span>
<span class="sd">      The address of the master process. The addresses should be formatted</span>
<span class="sd">      as &#39;ip:port&#39;. If the `start_cluster` flag is specified, the Database</span>
<span class="sd">      object will ssh into the provided address and start a master process.</span>
<span class="sd">      You should have ssh access to the target machine and scannerpy should</span>
<span class="sd">      be installed.</span>

<span class="sd">    workers</span>
<span class="sd">      The list of addresses to spawn worker processes on. The addresses</span>
<span class="sd">      should be formatted as &#39;ip:port&#39;. Like with `master`, you should have</span>
<span class="sd">      ssh access to the target machine and scannerpy should be installed. If</span>
<span class="sd">      `start_cluster` is false, this parameter has no effect.</span>

<span class="sd">    start_cluster</span>
<span class="sd">      If true, a master process and worker processes will be spawned at the</span>
<span class="sd">      addresses specified by `master` and `workers`, respectively.</span>

<span class="sd">    config_path</span>
<span class="sd">      Path to a Scanner configuration TOML, by default assumed to be</span>
<span class="sd">      &#39;~/.scanner/config.toml&#39;.</span>

<span class="sd">    config</span>
<span class="sd">      The scanner Config to use. If specified, config_path is ignored.</span>

<span class="sd">    debug</span>
<span class="sd">      This flag is only relevant when `start_cluster == True`. If true, the</span>
<span class="sd">      master and worker servers are spawned in the same process as the</span>
<span class="sd">      invoking python code, enabling easy gdb-based debugging.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    prefetch_table_metadata</span>

<span class="sd">    no_workers_timeout</span>

<span class="sd">    grpc_timeout</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Config</span>
<span class="sd">      The Config object used to initialize this Database.</span>

<span class="sd">    ops : OpGenerator</span>
<span class="sd">      Represents the set of available Ops. Ops can be created like so:</span>

<span class="sd">      `output = db.ops.ExampleOp(arg=&#39;example&#39;)`</span>

<span class="sd">      For a more detailed description, see :class:`~scannerpy.op.OpGenerator`</span>

<span class="sd">    sources : SourceGenerator</span>
<span class="sd">      Represents the set of available Sources. Sources are created just like Ops.</span>
<span class="sd">      See :class:`~scannerpy.op.SourceGenerator`</span>

<span class="sd">    sinks : SinkGenerator</span>
<span class="sd">      Represents the set of available Sinks. Sinks are created just like Ops.</span>
<span class="sd">      See :class:`~scannerpy.op.SinkGenerator`</span>

<span class="sd">    streams : StreamsGenerator</span>
<span class="sd">      Used to specify which elements to sample from a sequence.</span>
<span class="sd">      See :class:`~scannerpy.streams.StreamsGenerator`</span>

<span class="sd">    partitioner : TaskPartitioner</span>
<span class="sd">      Used to specify how to split the elements in a sequence when performing a</span>
<span class="sd">      slice operation. See :class:`~scannerpy.partitioner.TaskPartitioner`.</span>

<span class="sd">    protobufs : ProtobufGenerator</span>
<span class="sd">      Used to construct protobuf objects that handle serialization/deserialization</span>
<span class="sd">      of the outputs of Ops.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">master</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">workers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">start_cluster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">enable_watchdog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">prefetch_table_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">no_workers_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">grpc_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">new_job_retries_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">machine_params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cluster</span> <span class="o">=</span> <span class="n">start_cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workers_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_watchdog</span> <span class="o">=</span> <span class="n">enable_watchdog</span>
        <span class="c1"># Worker always has watchdog enabled to determine when master</span>
        <span class="c1"># connection has failed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_worker_watchdog</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_table_metadata</span> <span class="o">=</span> <span class="n">prefetch_table_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_workers_timeout</span> <span class="o">=</span> <span class="n">no_workers_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span> <span class="o">=</span> <span class="n">grpc_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_job_retries_limit</span> <span class="o">=</span> <span class="n">new_job_retries_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_machine_params</span> <span class="o">=</span> <span class="n">machine_params</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="p">(</span><span class="n">master</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_master</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bindings</span> <span class="o">=</span> <span class="n">bindings</span>

        <span class="c1"># Setup database metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_png_dump_prefix</span> <span class="o">=</span> <span class="s1">&#39;__png_dump_</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">OpGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">SourceGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks</span> <span class="o">=</span> <span class="n">SinkGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streams</span> <span class="o">=</span> <span class="n">StreamsGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitioner</span> <span class="o">=</span> <span class="n">TaskPartitioner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span> <span class="o">=</span> <span class="n">ProtobufGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enumerator_info_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sink_info_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_workers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_paths</span> <span class="o">=</span> <span class="n">workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_master</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Database crashed during config creation if this attr is missing</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_start_cluster&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_heartbeat</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_cluster</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_val</span><span class="p">,</span> <span class="n">exception_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_heartbeat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_cluster</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="k">def</span> <span class="nf">_load_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">descriptor</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">UserWarning</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Internal error. Missing file </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_save_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)),</span>
                            <span class="n">descriptor</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_load_table_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_names</span><span class="p">):</span>
        <span class="n">NUM_TABLES_TO_READ</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_names</span><span class="p">),</span> <span class="n">NUM_TABLES_TO_READ</span><span class="p">):</span>
            <span class="n">get_tables_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">GetTablesParams</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">NUM_TABLES_TO_READ</span><span class="p">]:</span>
                <span class="n">get_tables_params</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="n">get_tables_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetTables</span><span class="p">(</span><span class="n">get_tables_params</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">get_tables_result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Internal error: GetTables returned error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">get_tables_result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
            <span class="n">tables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_tables_result</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tables</span>

    <span class="k">def</span> <span class="nf">_load_db_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">DatabaseDescriptor</span><span class="p">,</span>
                                         <span class="s1">&#39;db_metadata.bin&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="c1"># table id cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table_id</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table_committed</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="s1">&#39;Internal error: multiple tables with same name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_id</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_committed</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">committed</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_table_metadata</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_descriptor</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Read all table descriptors from database</span>
                <span class="n">table_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_table_metadata</span><span class="p">(</span><span class="n">table_names</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_table_descriptor</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span>

    <span class="k">def</span> <span class="nf">_make_grpc_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="n">max_message_length</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="k">return</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;grpc.max_send_message_length&#39;</span><span class="p">,</span> <span class="n">max_message_length</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;grpc.max_receive_message_length&#39;</span><span class="p">,</span> <span class="n">max_message_length</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_connect_to_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_grpc_channel</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">WorkerStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">Ping</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Empty</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">worker</span>
        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">grpc</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">UNAVAILABLE</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Master ping errored with status: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_connect_to_master</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_grpc_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">MasterStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">Ping</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Empty</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">grpc</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">UNAVAILABLE</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">grpc</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Master ping errored with status: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_run_remote_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">nohup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">host_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">host_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">host_ip</span><span class="p">)</span><span class="o">.</span><span class="n">is_loopback</span> <span class="ow">or</span>
            <span class="n">host_name</span> <span class="o">==</span> <span class="s1">&#39;localhost&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Popen</span><span class="p">(</span>
                <span class="s2">&quot;ssh </span><span class="si">{}</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">cd </span><span class="si">{}</span><span class="s2"> &amp;&amp; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                                                      <span class="s1">&#39;&#39;</span>
                                                      <span class="k">if</span> <span class="n">nohup</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                                                      <span class="k">if</span> <span class="n">nohup</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Start up heartbeat to keep master alive</span>
        <span class="k">def</span> <span class="nf">heartbeat_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">,</span> <span class="n">master_address</span><span class="p">,</span> <span class="n">ppid</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux2&#39;</span><span class="p">:</span>
                <span class="n">prctl</span><span class="o">.</span><span class="n">set_pdeathsig</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_grpc_channel</span><span class="p">(</span><span class="n">master_address</span><span class="p">)</span>
            <span class="n">master</span> <span class="o">=</span> <span class="n">grpc_types</span><span class="o">.</span><span class="n">MasterStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getppid</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ppid</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">master</span><span class="o">.</span><span class="n">PokeWatchdog</span><span class="p">(</span>
                        <span class="n">rpc_types</span><span class="o">.</span><span class="n">Empty</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_stop_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">heartbeat_task</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_stop_event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_process</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stop_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_watchdog</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_stop_event</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span> <span class="ow">or</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span>
                <span class="ow">or</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span> <span class="ow">or</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span><span class="p">):</span>
            <span class="c1"># Stop cluster</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_heartbeat</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_cluster</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Result</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_get_source_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">):</span>
        <span class="n">source_info_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">SourceInfoArgs</span><span class="p">()</span>
        <span class="n">source_info_args</span><span class="o">.</span><span class="n">source_name</span> <span class="o">=</span> <span class="n">source_name</span>

        <span class="n">source_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetSourceInfo</span><span class="p">(</span><span class="n">source_info_args</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">source_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">source_info</span>

    <span class="k">def</span> <span class="nf">_get_enumerator_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enumerator_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enumerator_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enumerator_info_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enumerator_info_cache</span><span class="p">[</span><span class="n">enumerator_name</span><span class="p">]</span>

        <span class="n">enumerator_info_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">EnumeratorInfoArgs</span><span class="p">()</span>
        <span class="n">enumerator_info_args</span><span class="o">.</span><span class="n">enumerator_name</span> <span class="o">=</span> <span class="n">enumerator_name</span>

        <span class="n">enumerator_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetEnumeratorInfo</span><span class="p">(</span><span class="n">enumerator_info_args</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">enumerator_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">enumerator_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enumerator_info_cache</span><span class="p">[</span><span class="n">enumerator_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">enumerator_info</span>

        <span class="k">return</span> <span class="n">enumerator_info</span>

    <span class="k">def</span> <span class="nf">_get_sink_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sink_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sink_info_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sink_info_cache</span><span class="p">[</span><span class="n">sink_name</span><span class="p">]</span>

        <span class="n">sink_info_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">SinkInfoArgs</span><span class="p">()</span>
        <span class="n">sink_info_args</span><span class="o">.</span><span class="n">sink_name</span> <span class="o">=</span> <span class="n">sink_name</span>

        <span class="n">sink_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetSinkInfo</span><span class="p">(</span><span class="n">sink_info_args</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sink_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">sink_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sink_info_cache</span><span class="p">[</span><span class="n">sink_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sink_info</span>

        <span class="k">return</span> <span class="n">sink_info</span>

    <span class="k">def</span> <span class="nf">_get_op_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_cache</span><span class="p">:</span>
            <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_cache</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_info_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">OpInfoArgs</span><span class="p">()</span>
            <span class="n">op_info_args</span><span class="o">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="n">op_name</span>

            <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetOpInfo</span><span class="p">(</span><span class="n">op_info_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">op_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_op_cache</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_info</span>

        <span class="k">return</span> <span class="n">op_info</span>

    <span class="k">def</span> <span class="nf">_check_has_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_input_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span><span class="o">.</span><span class="n">input_columns</span>

    <span class="k">def</span> <span class="nf">_get_output_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span><span class="o">.</span><span class="n">output_columns</span>

    <span class="k">def</span> <span class="nf">_toposort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dag</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">dag</span>
        <span class="c1"># Perform DFS on modified graph</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">in_edges_left</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">source_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">explored_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">explored_nodes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">explored_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
                <span class="n">source_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">_inputs</span><span class="p">:</span>
                <span class="n">edges</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">_op</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">in_edges_left</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">_op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">explored_nodes</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">_op</span><span class="p">)</span>

        <span class="c1"># Keep track of position of input ops and sampling/slicing ops</span>
        <span class="c1"># to use for associating job args to</span>
        <span class="n">source_ops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stream_ops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output_ops</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Compute sorted list</span>
        <span class="n">eval_sorted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eval_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">source_nodes</span><span class="p">[:]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">eval_sorted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">op_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">eval_index</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_idx</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                <span class="n">in_edges_left</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">in_edges_left</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
                <span class="n">source_ops</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_idx</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s2">&quot;Sample&quot;</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s2">&quot;Space&quot;</span>
                  <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s2">&quot;Slice&quot;</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s2">&quot;Unslice&quot;</span><span class="p">):</span>
                <span class="n">stream_ops</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_idx</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
                <span class="n">output_ops</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_idx</span>

        <span class="k">return</span> <span class="n">eval_sorted</span><span class="p">,</span> \
            <span class="n">eval_index</span><span class="p">,</span> \
            <span class="n">source_ops</span><span class="p">,</span> \
            <span class="n">stream_ops</span><span class="p">,</span> \
            <span class="n">output_ops</span>

    <span class="k">def</span> <span class="nf">_parse_size_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mults</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Invalid size suffix in &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">*</span> <span class="n">mults</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span>

<div class="viewcode-block" id="Database.load_op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.load_op">[docs]</a>    <span class="k">def</span> <span class="nf">load_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">so_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Loads a custom op into the Scanner runtime.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        so_path</span>
<span class="sd">          Path to the custom op&#39;s shared library (.so).</span>

<span class="sd">        proto_path</span>
<span class="sd">          Path to the custom op&#39;s arguments protobuf if one exists.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ScannerException</span>
<span class="sd">          Raised when the master fails to load the op.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proto_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">proto_path</span><span class="p">)</span>
        <span class="n">op_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">OpPath</span><span class="p">()</span>
        <span class="n">op_path</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">so_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">LoadOp</span><span class="p">(</span><span class="n">op_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.has_gpu"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.has_gpu">[docs]</a>    <span class="k">def</span> <span class="nf">has_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Database.summarize"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.summarize">[docs]</a>    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a human-readable summarization of the database state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">db_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_db_metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Your database is empty!&#39;</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;TABLES&#39;</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;# rows&#39;</span><span class="p">,</span>
                 <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">num_rows</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;Columns&#39;</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">column_names</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span>
                <span class="p">]),</span>
                <span class="p">(</span><span class="s1">&#39;Committed&#39;</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">committed</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span>
                <span class="p">]),</span>
            <span class="p">]),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">table_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">table_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">max_col_lens</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span>
            <span class="p">]</span>
            <span class="n">table_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">max_col_lens</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;** </span><span class="si">{}</span><span class="s1"> **&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">table_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">table_width</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">col_name_fmt</span> <span class="o">=</span> <span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{{:</span><span class="si">{}</span><span class="s1">}}&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cols</span><span class="p">)])</span>
            <span class="n">col_name_fmt</span> <span class="o">=</span> <span class="n">col_name_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">max_col_lens</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="n">col_name_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="n">table_width</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">row_fmt</span> <span class="o">=</span> <span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{{:</span><span class="si">{}</span><span class="s1">}}&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cols</span><span class="p">)])</span>
            <span class="n">row_fmt</span> <span class="o">=</span> <span class="n">row_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">max_col_lens</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="n">row_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">summary</span></div>

<div class="viewcode-block" id="Database.start_master"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.start_master">[docs]</a>    <span class="k">def</span> <span class="nf">start_master</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Starts a Scanner master.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        master</span>
<span class="sd">          ssh-able address of the master node.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">master</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_address</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_port</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span> <span class="o">=</span> <span class="n">master</span>

        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Did you forget to specify the master port number? &#39;</span>
                 <span class="s1">&#39;Specified address is </span><span class="si">{s:s}</span><span class="s1">. It should look like </span><span class="si">{s:s}</span><span class="s1">:5001&#39;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">))</span>

        <span class="c1"># Start up heartbeat to keep master alive</span>
        <span class="c1"># NOTE(apoms): This MUST BE before any grpc channel is created, since it</span>
        <span class="c1"># forks a process and forking after channel creation causes hangs in the</span>
        <span class="c1"># forked process under grpc</span>
        <span class="c1"># https://github.com/grpc/grpc/issues/13873#issuecomment-358476408</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_watchdog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_heartbeat</span><span class="p">()</span>

        <span class="c1"># Boot up C++ database bindings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bindings</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_config</span><span class="p">,</span>
                                           <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">),</span>
                                           <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_cluster</span><span class="p">:</span>
            <span class="c1"># Set handler to shutdown cluster on signal</span>
            <span class="c1"># TODO(apoms): we should clear these handlers when stopping</span>
            <span class="c1"># the cluster</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bindings</span><span class="o">.</span><span class="n">start_master</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_port</span><span class="p">,</span> <span class="n">SCRIPT_DIR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_watchdog</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_no_workers_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_job_retries_limit</span><span class="p">)</span><span class="o">.</span><span class="n">success</span>
                <span class="k">assert</span> <span class="n">res</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_to_master</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="s1">&#39;Failed to connect to local master process on port &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">. (Is there another process that is bound to that &#39;</span>
                        <span class="s1">&#39;port already?)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_port</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">master_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># https://stackoverflow.com/questions/30469575/how-to-pickle-and-unpickle-to-portable-string-in-python-3</span>
                <span class="n">pickled_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">master_cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;python3 -c &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">from scannerpy import start_master</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;import pickle</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;config=pickle.loads(bytes(</span><span class="se">\&#39;\&#39;\&#39;</span><span class="si">{config:s}</span><span class="se">\&#39;\&#39;\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">utf8</span><span class="se">\&#39;</span><span class="s1">))</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39;start_master(port=</span><span class="se">\&#39;</span><span class="si">{master_port:s}</span><span class="se">\&#39;</span><span class="s1">, block=True,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;             config=config, watchdog=</span><span class="si">{watchdog}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;             no_workers_timeout=</span><span class="si">{no_workers}</span><span class="s1">)</span><span class="se">\&quot;</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">master_port</span><span class="o">=</span><span class="n">master_port</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">pickled_config</span><span class="p">,</span>
                        <span class="n">watchdog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_watchdog</span><span class="p">,</span>
                        <span class="n">no_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_workers_timeout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_remote_cmd</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">,</span> <span class="n">master_cmd</span><span class="p">,</span> <span class="n">nohup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Wait for master to start</span>
                <span class="n">slept_so_far</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">60</span>
                <span class="k">while</span> <span class="n">slept_so_far</span> <span class="o">&lt;</span> <span class="n">sleep_time</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_to_master</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                    <span class="n">slept_so_far</span> <span class="o">+=</span> <span class="mf">0.3</span>
                <span class="k">if</span> <span class="n">slept_so_far</span> <span class="o">&gt;=</span> <span class="n">sleep_time</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="s1">&#39;Timed out waiting to connect to master&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Wait for master to start</span>
            <span class="n">slept_so_far</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">while</span> <span class="n">slept_so_far</span> <span class="o">&lt;</span> <span class="n">sleep_time</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_to_master</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">slept_so_far</span> <span class="o">+=</span> <span class="mf">0.3</span>
            <span class="k">if</span> <span class="n">slept_so_far</span> <span class="o">&gt;=</span> <span class="n">sleep_time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Timed out waiting to connect to master&#39;</span><span class="p">)</span>

        <span class="c1"># Load stdlib</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux2&#39;</span><span class="p">:</span>
            <span class="n">EXT</span> <span class="o">=</span> <span class="s1">&#39;.so&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">EXT</span> <span class="o">=</span> <span class="s1">&#39;.dylib&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_op</span><span class="p">(</span><span class="s1">&#39;__stdlib&#39;</span> <span class="o">+</span> <span class="n">EXT</span><span class="p">,</span>
                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/../scanner/stdlib/stdlib_pb2.py&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SCRIPT_DIR</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.start_workers"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.start_workers">[docs]</a>    <span class="k">def</span> <span class="nf">start_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Starts Scanner workers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        workers</span>
<span class="sd">          list of ssh-able addresses of the worker nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_addresses</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_address</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">worker_port</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_addresses</span> <span class="o">=</span> <span class="n">workers</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">machine_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_machine_params</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bindings</span><span class="o">.</span><span class="n">default_machine_params</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_addresses</span><span class="p">)):</span>
                <span class="n">start_worker</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">,</span>
                    <span class="n">port</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">worker_port</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                    <span class="n">watchdog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_worker_watchdog</span><span class="p">,</span>
                    <span class="n">machine_params</span><span class="o">=</span><span class="n">machine_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickled_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">worker_cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;python3 -c &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">from scannerpy import start_worker</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;import pickle</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;config=pickle.loads(bytes(</span><span class="se">\&#39;\&#39;\&#39;</span><span class="si">{config:s}</span><span class="se">\&#39;\&#39;\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">utf8</span><span class="se">\&#39;</span><span class="s1">))</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="o">+</span> <span class="s1">&#39;start_worker(</span><span class="se">\&#39;</span><span class="si">{master:s}</span><span class="se">\&#39;</span><span class="s1">, port=</span><span class="se">\&#39;</span><span class="si">{worker_port:s}</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;             block=True,</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;             watchdog=</span><span class="si">{watchdog}</span><span class="s1">,&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;             config=config)</span><span class="se">\&quot;</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Start workers now that master is ready</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ignored_nodes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_addresses</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_remote_cmd</span><span class="p">(</span>
                            <span class="n">w</span><span class="p">,</span>
                            <span class="n">worker_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">master</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_master_address</span><span class="p">,</span>
                                <span class="n">config</span><span class="o">=</span><span class="n">pickled_config</span><span class="p">,</span>
                                <span class="n">watchdog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_worker_watchdog</span><span class="p">,</span>
                                <span class="n">worker_port</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="n">nohup</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;WARNING: Failed to ssh into </span><span class="si">{:s}</span><span class="s1"> because: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">w</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="n">ignored_nodes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">slept_so_far</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Has to be this long for GCS</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="k">while</span> <span class="n">slept_so_far</span> <span class="o">&lt;</span> <span class="n">sleep_time</span><span class="p">:</span>
                <span class="n">active_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">ActiveWorkers</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Empty</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_workers</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;Master has more workers than requested &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;(</span><span class="si">{:d}</span><span class="s1"> vs </span><span class="si">{:d}</span><span class="s1">)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">active_workers</span><span class="o">.</span><span class="n">workers</span><span class="p">),</span>
                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="p">)))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_workers</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="p">)):</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">slept_so_far</span> <span class="o">+=</span> <span class="mf">0.3</span>
            <span class="k">if</span> <span class="n">slept_so_far</span> <span class="o">&gt;=</span> <span class="n">sleep_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_cluster</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Timed out waiting for workers to connect to master&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ignored_nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Ignored </span><span class="si">{:d}</span><span class="s1"> nodes during startup.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ignored_nodes</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_workers_started</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Database.stop_cluster"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.stop_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">stop_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Stops the Scanner master and workers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="p">:</span>
                <span class="c1"># Stop heartbeat</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_heartbeat</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
                        <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">Shutdown</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Empty</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_master</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_master_conn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">wc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span><span class="p">:</span>
                    <span class="n">wc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_worker_conns</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Database.register_op"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.register_op">[docs]</a>    <span class="k">def</span> <span class="nf">register_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">input_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnType</span><span class="p">]]],</span>
                    <span class="n">output_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColumnType</span><span class="p">]]],</span>
                    <span class="n">variadic_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">stencil</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">unbounded_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">bounded_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">proto_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Register a new Op with the Scanner master.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name</span>
<span class="sd">          Name of the Op.</span>

<span class="sd">        input_columns</span>
<span class="sd">          A list of the inputs for this Op. Can be either the name of the input</span>
<span class="sd">          as a string or a tuple of (&#39;name&#39;, ColumnType). If only the name is</span>
<span class="sd">          specified as a string, the ColumnType is assumed to be</span>
<span class="sd">          ColumnType.Blob.</span>

<span class="sd">        output_columns</span>
<span class="sd">          A list of the outputs for this Op. Can be either the name of the output</span>
<span class="sd">          as a string or a tuple of (&#39;name&#39;, ColumnType). If only the name is</span>
<span class="sd">          specified as a string, the ColumnType is assumed to be</span>
<span class="sd">          ColumnType.Blob.</span>

<span class="sd">        variadic_inputs</span>
<span class="sd">          If true, this Op may take a variable number of inputs and</span>
<span class="sd">          `input_columns` is ignored. Variadic inputs are specified as</span>
<span class="sd">          positional arguments when invoking the Op, instead of keyword</span>
<span class="sd">          arguments.</span>

<span class="sd">        stencil</span>
<span class="sd">          Specifies the default stencil to use for the Op. If none, indicates</span>
<span class="sd">          that the the Op does not have the ability to stencil. A stencil of</span>
<span class="sd">          [0] should be specified if the Op can stencil but should not by</span>
<span class="sd">          default.</span>

<span class="sd">        unbounded_state</span>
<span class="sd">          If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">          of its input sequences before it can compute a given element. For</span>
<span class="sd">          example, to compute output element at index 100, the Op must have</span>
<span class="sd">          already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">          with `bounded_state`.</span>

<span class="sd">        bounded_state</span>
<span class="sd">          If true, indicates that the Op needs to see all previous elements</span>
<span class="sd">          of its input sequences before it can compute a given element. For</span>
<span class="sd">          example, to compute output element at index 100, the Op must have</span>
<span class="sd">          already produced elements 0-99. This option is mutually exclusive</span>
<span class="sd">          with `bounded_state`.</span>

<span class="sd">        proto_path</span>
<span class="sd">          Optional path to the proto file that describes the configuration</span>
<span class="sd">          arguments to this Op.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ScannerException</span>
<span class="sd">          Raised when the master fails to register the Op.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">op_registration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">OpRegistration</span><span class="p">()</span>
        <span class="n">op_registration</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">op_registration</span><span class="o">.</span><span class="n">variadic_inputs</span> <span class="o">=</span> <span class="n">variadic_inputs</span>
        <span class="n">op_registration</span><span class="o">.</span><span class="n">has_unbounded_state</span> <span class="o">=</span> <span class="n">unbounded_state</span>

        <span class="k">def</span> <span class="nf">add_col</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Other</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ColumnType</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Column &#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39; must be a string name or a tuple of &#39;</span>
                    <span class="s1">&#39;(name, column_type)&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">in_col</span> <span class="ow">in</span> <span class="n">input_columns</span><span class="p">:</span>
            <span class="n">add_col</span><span class="p">(</span><span class="n">op_registration</span><span class="o">.</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">in_col</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">out_col</span> <span class="ow">in</span> <span class="n">output_columns</span><span class="p">:</span>
            <span class="n">add_col</span><span class="p">(</span><span class="n">op_registration</span><span class="o">.</span><span class="n">output_columns</span><span class="p">,</span> <span class="n">out_col</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stencil</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">op_registration</span><span class="o">.</span><span class="n">can_stencil</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_registration</span><span class="o">.</span><span class="n">can_stencil</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">op_registration</span><span class="o">.</span><span class="n">preferred_stencil</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">stencil</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bounded_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounded_state</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="n">op_registration</span><span class="o">.</span><span class="n">has_bounded_state</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">op_registration</span><span class="o">.</span><span class="n">warmup</span> <span class="o">=</span> <span class="n">bounded_state</span>

        <span class="k">if</span> <span class="n">proto_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">proto_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">RegisterOp</span><span class="p">(</span>
            <span class="n">op_registration</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span></div>

<div class="viewcode-block" id="Database.register_python_kernel"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.register_python_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">register_python_kernel</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">device_type</span><span class="p">:</span> <span class="n">DeviceType</span><span class="p">,</span>
            <span class="n">kernel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">,</span>
                          <span class="n">Kernel</span><span class="p">],</span>
            <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Register a Python Kernel with the Scanner master.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        op_name</span>
<span class="sd">          Name of the Op.</span>

<span class="sd">        device_type</span>
<span class="sd">          The device type of the resource this kernel uses.</span>

<span class="sd">        kernel</span>
<span class="sd">          The class or function that implements the kernel.</span>

<span class="sd">        batch</span>
<span class="sd">          Specifies a default for how many elements this kernel should batch</span>
<span class="sd">          over. If `batch == 1`, kernel is assume to not be able to batch.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ScannerException</span>
<span class="sd">          Raised when the master fails to register the kernel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">kernel</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">):</span>

            <span class="k">class</span> <span class="nc">KernelWrapper</span><span class="p">(</span><span class="n">Kernel</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>

                <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>

            <span class="n">kernel_cls</span> <span class="o">=</span> <span class="n">KernelWrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel_cls</span> <span class="o">=</span> <span class="n">kernel</span>

        <span class="n">py_registration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">PythonKernelRegistration</span><span class="p">()</span>
        <span class="n">py_registration</span><span class="o">.</span><span class="n">op_name</span> <span class="o">=</span> <span class="n">op_name</span>
        <span class="n">py_registration</span><span class="o">.</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">device_type</span><span class="p">)</span>
        <span class="n">py_registration</span><span class="o">.</span><span class="n">kernel_code</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kernel_cls</span><span class="p">)</span>
        <span class="n">py_registration</span><span class="o">.</span><span class="n">pickled_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">py_registration</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">RegisterPythonKernel</span><span class="p">(</span>
                <span class="n">py_registration</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_ops</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.ingest_videos"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.ingest_videos">[docs]</a>    <span class="k">def</span> <span class="nf">ingest_videos</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">videos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
            <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Creates tables from videos.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        videos</span>
<span class="sd">          The list of videos to ingest into the database. Each element in the</span>
<span class="sd">          list should be (&#39;table_name&#39;, &#39;path/to/video&#39;).</span>

<span class="sd">        inplace</span>
<span class="sd">          If true, ingests the videos without copying them into the database.</span>
<span class="sd">          Currently only supported for mp4 containers.</span>

<span class="sd">        force</span>
<span class="sd">          If true, deletes existing tables with the same names.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tables: List[Table]</span>
<span class="sd">          List of table objects for the ingested videos.</span>

<span class="sd">        failures: List[Tuple[str, str]]</span>
<span class="sd">          List of (&#39;path/to/video&#39;, &#39;reason for failure&#39;) tuples for each video</span>
<span class="sd">          which failed to ingest.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Must ingest at least one video.&#39;</span><span class="p">)</span>

        <span class="p">[</span><span class="n">table_names</span><span class="p">,</span> <span class="n">paths</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">videos</span><span class="p">))</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">force</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                        <span class="s1">&#39;Attempted to ingest over existing table </span><span class="si">{}</span><span class="s1">&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_tables</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
        <span class="n">ingest_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">IngestParameters</span><span class="p">()</span>
        <span class="n">ingest_params</span><span class="o">.</span><span class="n">table_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">table_names</span><span class="p">)</span>
        <span class="n">ingest_params</span><span class="o">.</span><span class="n">video_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">ingest_params</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">inplace</span>
        <span class="n">ingest_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">IngestVideos</span><span class="p">(</span><span class="n">ingest_params</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ingest_result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">ingest_result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">ingest_result</span><span class="o">.</span><span class="n">failed_paths</span><span class="p">,</span> <span class="n">ingest_result</span><span class="o">.</span><span class="n">failed_messages</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="n">videos</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingest_result</span><span class="o">.</span><span class="n">failed_paths</span>
        <span class="p">],</span> <span class="n">failures</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.has_table"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.has_table">[docs]</a>    <span class="k">def</span> <span class="nf">has_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks if a table exists in the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name</span>
<span class="sd">          The name of the table to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">          True if the table exists, false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_db_metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Database.delete_tables"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.delete_tables">[docs]</a>    <span class="k">def</span> <span class="nf">delete_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Deletes tables from the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        names</span>
<span class="sd">          The names of the tables to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delete_tables_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">DeleteTablesParams</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">delete_tables_params</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">DeleteTables</span><span class="p">(</span><span class="n">delete_tables_params</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Database.delete_table"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.delete_table">[docs]</a>    <span class="k">def</span> <span class="nf">delete_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Deletes a table from the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name</span>
<span class="sd">          The name of the table to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_tables</span><span class="p">([</span><span class="n">name</span><span class="p">])</span></div>

<div class="viewcode-block" id="Database.new_table"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.new_table">[docs]</a>    <span class="k">def</span> <span class="nf">new_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]],</span>
                  <span class="n">fns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Creates a new table from a list of rows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name</span>
<span class="sd">          String name of the table to create</span>

<span class="sd">        columns</span>
<span class="sd">          List of names of table columns</span>

<span class="sd">        rows</span>
<span class="sd">          List of rows with each row a list of elements corresponding</span>
<span class="sd">          to the specified columns. Elements must be strings of</span>
<span class="sd">          serialized representations of the data.</span>

<span class="sd">        fns</span>

<span class="sd">        force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Table</span>
<span class="sd">          The new table object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_table</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Attempted to create table with existing &#39;</span>
                    <span class="s1">&#39;name </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fn</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">NewTableParams</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">columns</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="n">row_proto</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">row_proto</span><span class="o">.</span><span class="n">columns</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">row</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">NewTable</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.table"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.table">[docs]</a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Retrieves a Table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name</span>
<span class="sd">          Name of the table to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Table</span>
<span class="sd">          The table object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_db_metadata</span><span class="p">()</span>

        <span class="n">table_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">table_id</span> <span class="o">=</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">table_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Table with name </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_id</span><span class="p">:</span>
                <span class="n">table_id</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_id</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">table_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Table with id </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Invalid table identifier&#39;</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_table_metadata</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">_descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_descriptor</span><span class="p">[</span><span class="n">table_id</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">table</span></div>

<div class="viewcode-block" id="Database.profiler"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.profiler">[docs]</a>    <span class="k">def</span> <span class="nf">profiler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">db_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_db_metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">bulk_jobs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">job_name</span><span class="p">:</span>
                    <span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Job name </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_name</span>

        <span class="k">return</span> <span class="n">Profiler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Database.get_active_jobs"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.get_active_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">GetJobsRequest</span><span class="p">()</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetJobs</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reply</span><span class="o">.</span><span class="n">active_bulk_jobs</span><span class="p">]</span></div>

<div class="viewcode-block" id="Database.wait_on_job_gen"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.wait_on_job_gen">[docs]</a>    <span class="k">def</span> <span class="nf">wait_on_job_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulk_job_id</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total_tasks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">last_task_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_jobs_failed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_failed_workers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">GetJobStatusRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">bulk_job_id</span> <span class="o">=</span> <span class="n">bulk_job_id</span>
                <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetJobStatus</span><span class="p">(</span>
                    <span class="n">req</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_progress</span> <span class="ow">and</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_status</span><span class="o">.</span><span class="n">total_jobs</span> <span class="o">!=</span> <span class="mi">0</span> \
                   <span class="ow">and</span> <span class="n">job_status</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">total_tasks</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">total_tasks</span>
                    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_tasks</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_status</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tasks_completed</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">tasks_done</span>
                <span class="k">if</span> <span class="n">tasks_completed</span> <span class="o">-</span> <span class="n">last_task_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tasks_completed</span> <span class="o">-</span> <span class="n">last_task_count</span><span class="p">)</span>
                <span class="n">last_task_count</span> <span class="o">=</span> <span class="n">tasks_completed</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
                    <span class="s1">&#39;jobs&#39;</span><span class="p">:</span>
                    <span class="n">job_status</span><span class="o">.</span><span class="n">total_jobs</span> <span class="o">-</span> <span class="n">job_status</span><span class="o">.</span><span class="n">jobs_done</span><span class="p">,</span>
                    <span class="s1">&#39;tasks&#39;</span><span class="p">:</span>
                    <span class="n">job_status</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">-</span> <span class="n">job_status</span><span class="o">.</span><span class="n">tasks_done</span><span class="p">,</span>
                    <span class="s1">&#39;workers&#39;</span><span class="p">:</span>
                    <span class="n">job_status</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">time_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%l:%M%p %z on %b </span><span class="si">%d</span><span class="s1">, %Y&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last_jobs_failed</span> <span class="o">&lt;</span> <span class="n">job_status</span><span class="o">.</span><span class="n">jobs_failed</span><span class="p">:</span>
                    <span class="n">num_jobs_failed</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">jobs_failed</span> <span class="o">-</span> <span class="n">last_jobs_failed</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1"> failed at </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">num_jobs_failed</span><span class="p">,</span> <span class="s1">&#39;job&#39;</span>
                        <span class="k">if</span> <span class="n">num_jobs</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="n">time_str</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">last_failed_workers</span> <span class="o">&lt;</span> <span class="n">job_status</span><span class="o">.</span><span class="n">failed_workers</span><span class="p">:</span>
                    <span class="n">num_workers_failed</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">failed_workers</span> <span class="o">-</span> <span class="n">last_failed_workers</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1"> failed at </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">num_workers_failed</span><span class="p">,</span> <span class="s1">&#39;worker&#39;</span>
                        <span class="k">if</span> <span class="n">num_workers_failed</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;workers&#39;</span><span class="p">,</span> <span class="n">time_str</span><span class="p">))</span>
                <span class="n">last_jobs_failed</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">jobs_failed</span>
                <span class="n">last_failed_workers</span> <span class="o">=</span> <span class="n">job_status</span><span class="o">.</span><span class="n">failed_workers</span>
            <span class="k">yield</span>

        <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">total_tasks</span> <span class="o">-</span> <span class="n">last_task_count</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">yield</span> <span class="n">job_status</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Database.wait_on_job"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.wait_on_job">[docs]</a>    <span class="k">def</span> <span class="nf">wait_on_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sleep_schedule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
            <span class="n">sleep_schedule</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_on_job_gen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sleep_attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_status</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sleep_attempt</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sleep_schedule</span><span class="p">):</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_schedule</span><span class="p">[</span><span class="n">sleep_attempt</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">sleep_attempt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">job_status</span></div>

<div class="viewcode-block" id="Database.bulk_fetch_video_metadata"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.bulk_fetch_video_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_fetch_video_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">GetVideoMetadataParams</span><span class="p">(</span>
            <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">GetVideoMetadata</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">videos</span></div>

<div class="viewcode-block" id="Database.run"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.Database.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Sink</span><span class="p">,</span>
            <span class="n">jobs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Job</span><span class="p">],</span>
            <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">work_packet_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
            <span class="n">io_packet_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
            <span class="n">cpu_pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">gpu_pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">pipeline_instances_per_node</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">profiling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">load_sparsity_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">tasks_in_queue_per_pu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">task_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">checkpoint_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">detach</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">profiler_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs a collection of jobs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output</span>
<span class="sd">          The Sink that should be processed.</span>

<span class="sd">        jobs</span>
<span class="sd">          The set of jobs to process. All of these jobs should share the same</span>
<span class="sd">          graph of operations.</span>

<span class="sd">        force</span>
<span class="sd">          If the output tables already exist, overwrite them.</span>

<span class="sd">        work_packet_size</span>
<span class="sd">          The size of the packets of intermediate elements to pass between</span>
<span class="sd">          operations. This parameter only affects performance and should not</span>
<span class="sd">          affect the output.</span>

<span class="sd">        io_packet_size</span>
<span class="sd">          The size of the packets of elements to read and write from Sources and</span>
<span class="sd">          sinks. This parameter only affects performance and should not</span>
<span class="sd">          affect the output. When reading and writing to high latency storage</span>
<span class="sd">          (such as the cloud), it is helpful to increase this value.</span>

<span class="sd">        cpu_pool</span>

<span class="sd">        gpu_pool</span>

<span class="sd">        pipeline_instances_per_node</span>
<span class="sd">          The number of concurrent instances of the computation graph to</span>
<span class="sd">          execute. If set to None, it will be automatically inferred based on</span>
<span class="sd">          computation graph and the available machine resources.</span>

<span class="sd">        show_progress</span>
<span class="sd">          If true, will display an ASCII progress bar measuring job status.</span>

<span class="sd">        profiling</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        load_sparsity_threshold</span>

<span class="sd">        tasks_in_queue_per_pu</span>

<span class="sd">        task_timeout</span>

<span class="sd">        checkpoint_frequency</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Table]</span>
<span class="sd">          The new table objects if `output` is a db.sinks.Column, otherwise an</span>
<span class="sd">          empty list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Sink</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;FrameColumn&#39;</span> <span class="ow">or</span> <span class="n">output</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;Column&#39;</span><span class="p">):</span>
            <span class="n">is_table_output</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_table_output</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Collect compression annotations to add to job</span>
        <span class="n">compression_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_op</span> <span class="o">=</span> <span class="n">output</span>
        <span class="k">for</span> <span class="n">out_col</span> <span class="ow">in</span> <span class="n">output_op</span><span class="o">.</span><span class="n">inputs</span><span class="p">():</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">OutputColumnCompression</span><span class="p">()</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
            <span class="k">if</span> <span class="n">out_col</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">Video</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out_col</span><span class="o">.</span><span class="n">_encode_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;codec&#39;</span><span class="p">:</span>
                        <span class="n">opts</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">opts</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">compression_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="c1"># Get output columns</span>
        <span class="n">output_column_names</span> <span class="o">=</span> <span class="n">output_op</span><span class="o">.</span><span class="n">_output_names</span>

        <span class="n">sorted_ops</span><span class="p">,</span> <span class="n">op_index</span><span class="p">,</span> <span class="n">source_ops</span><span class="p">,</span> <span class="n">stream_ops</span><span class="p">,</span> <span class="n">output_ops</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_toposort</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

        <span class="n">job_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">BulkJobParameters</span><span class="p">()</span>
        <span class="n">job_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">ascii_uppercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">to_proto</span><span class="p">(</span><span class="n">op_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sorted_ops</span><span class="p">])</span>
        <span class="n">job_output_table_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">output_column_names</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">output_column_names</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">job_params</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">output_table_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Build lookup from op to op_args</span>
            <span class="n">op_to_op_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">op_col</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">op_args</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_col</span><span class="p">,</span> <span class="n">Op</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_col</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">op_col</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">op_col</span><span class="o">.</span><span class="n">_op</span>

                <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>

            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">sorted_ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">source_ops</span><span class="p">:</span>
                    <span class="n">op_idx</span> <span class="o">=</span> <span class="n">source_ops</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_to_op_args</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;No arguments bound to source </span><span class="si">{:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">op</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>

                    <span class="n">args</span> <span class="o">=</span> <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="n">source_input</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                    <span class="n">source_input</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">op_idx</span>
                    <span class="c1"># We special case on Column to transform it into a</span>
                    <span class="c1"># (table, col) pair that is then transformed into a</span>
                    <span class="c1"># protobuf object</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">committed</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                                <span class="s1">&#39;Attempted to bind table </span><span class="si">{name}</span><span class="s1"> to Input Op &#39;</span>
                                <span class="s1">&#39;but table </span><span class="si">{name}</span><span class="s1"> is not committed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;table_name&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                            <span class="s1">&#39;column_name&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                        <span class="p">}</span>
                        <span class="n">full_args</span> <span class="o">=</span> <span class="n">args</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Op arguments must be a dictionary, recevied: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
                        <span class="n">full_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">op</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">}</span>

                    <span class="n">n</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_name</span>
                    <span class="n">enumerator_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_enumerator_info</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enumerator_info</span><span class="o">.</span><span class="n">protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">enumerator_proto_name</span> <span class="o">=</span> <span class="n">enumerator_info</span><span class="o">.</span><span class="n">protobuf_name</span>
                            <span class="n">source_input</span><span class="o">.</span><span class="n">enumerator_args</span> <span class="o">=</span> <span class="n">python_to_proto</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">enumerator_proto_name</span><span class="p">,</span>
                                <span class="n">full_args</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">source_input</span><span class="o">.</span><span class="n">enumerator_args</span> <span class="o">=</span> <span class="n">full_args</span>
                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">stream_ops</span><span class="p">:</span>
                    <span class="n">op_idx</span> <span class="o">=</span> <span class="n">stream_ops</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="c1"># If this is an Unslice Op, ignore it since it has no args</span>
                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;Unslice&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># Check for default. If no default</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_to_op_args</span><span class="p">:</span>
                        <span class="c1"># If no args specified, check for default args</span>
                        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">_extra</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_extra</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                                <span class="s1">&#39;No arguments bound to stream operation </span><span class="si">{:s}</span><span class="s1"> &#39;</span>
                                <span class="s1">&#39;and no default arguments specified.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">op</span><span class="o">.</span><span class="n">_extra</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>

                    <span class="n">saa</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">sampling_args_assignment</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                    <span class="n">saa</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">op_idx</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">op</span><span class="o">.</span><span class="n">_extra</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Gather&#39;</span> <span class="ow">and</span>
                         <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                         <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>

                    <span class="n">arg_builder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_extra</span><span class="p">[</span><span class="s1">&#39;arg_builder&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="c1"># Construct the sampling_args using the arg_builder</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                            <span class="c1"># Positional arguments</span>
                            <span class="n">sargs</span> <span class="o">=</span> <span class="n">arg_builder</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="c1"># Keyword arguments</span>
                            <span class="n">sargs</span> <span class="o">=</span> <span class="n">arg_builder</span><span class="p">(</span><span class="o">**</span><span class="n">arg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Single argument</span>
                            <span class="n">sargs</span> <span class="o">=</span> <span class="n">arg_builder</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                        <span class="n">sa</span> <span class="o">=</span> <span class="n">saa</span><span class="o">.</span><span class="n">sampling_args</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                        <span class="n">sa</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">sargs</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">output_ops</span><span class="p">:</span>
                    <span class="n">op_idx</span> <span class="o">=</span> <span class="n">output_ops</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="n">sink_args</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                    <span class="n">sink_args</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">op_idx</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_to_op_args</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;No arguments bound to sink </span><span class="si">{:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">op</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>

                    <span class="c1"># We special case on FrameColumn or Column sinks to catch</span>
                    <span class="c1"># the output table name</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_name</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;FrameColumn&#39;</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="s1">&#39;Column&#39;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="n">output_table_name</span> <span class="o">=</span> <span class="n">args</span>
                        <span class="n">job_output_table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Encode the args</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">sink_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sink_info</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sink_info</span><span class="o">.</span><span class="n">stream_protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">sink_proto_name</span> <span class="o">=</span> <span class="n">sink_info</span><span class="o">.</span><span class="n">stream_protobuf_name</span>
                                <span class="n">sink_args</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">python_to_proto</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">sink_proto_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sink_args</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
                        <span class="n">output_table_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Regular old Op</span>
                    <span class="n">op_idx</span> <span class="o">=</span> <span class="n">op_index</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="n">oargs</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">op_args</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                    <span class="n">oargs</span><span class="o">.</span><span class="n">op_index</span> <span class="o">=</span> <span class="n">op_idx</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_to_op_args</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">op_to_op_args</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>

                    <span class="c1"># Encode the args</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_name</span>
                    <span class="k">def</span> <span class="nf">serialize_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_ops</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">op_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_op_info</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">proto_name</span> <span class="o">=</span> <span class="n">op_info</span><span class="o">.</span><span class="n">protobuf_name</span>
                                    <span class="k">return</span> <span class="n">python_to_proto</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="p">,</span> <span class="n">proto_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">args</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">oargs</span><span class="o">.</span><span class="n">op_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serialize_args</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">is_table_output</span> <span class="ow">and</span> <span class="n">output_table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                    <span class="s1">&#39;Did not specify the output table name by binding a &#39;</span>
                    <span class="s1">&#39;string to the output Op.&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">output_table_name</span> <span class="o">=</span> <span class="n">output_table_name</span>

        <span class="c1"># Delete tables if they exist and force was specified</span>
        <span class="k">if</span> <span class="n">is_table_output</span><span class="p">:</span>
            <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">job_output_table_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                        <span class="n">to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                            <span class="s1">&#39;Job would overwrite existing table </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_tables</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>

        <span class="n">job_params</span><span class="o">.</span><span class="n">compression</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">compression_options</span><span class="p">)</span>

        <span class="n">job_params</span><span class="o">.</span><span class="n">pipeline_instances_per_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipeline_instances_per_node</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">work_packet_size</span> <span class="o">=</span> <span class="n">work_packet_size</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">io_packet_size</span> <span class="o">=</span> <span class="n">io_packet_size</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">profiling</span> <span class="o">=</span> <span class="n">profiling</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">tasks_in_queue_per_pu</span> <span class="o">=</span> <span class="n">tasks_in_queue_per_pu</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">load_sparsity_threshold</span> <span class="o">=</span> <span class="n">load_sparsity_threshold</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protobufs</span><span class="o">.</span><span class="n">BulkJobParameters</span><span class="o">.</span><span class="n">REPEAT_EDGE</span><span class="p">)</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">task_timeout</span> <span class="o">=</span> <span class="n">task_timeout</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">checkpoint_frequency</span> <span class="o">=</span> <span class="n">checkpoint_frequency</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">profiler_level</span> <span class="o">=</span> <span class="n">profiler_level</span>

        <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">pinned_cpu</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cpu_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">use_pool</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">cpu_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">pinned_cpu</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cpu_pool</span> <span class="o">=</span> <span class="n">cpu_pool</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_size_string</span><span class="p">(</span><span class="n">cpu_pool</span><span class="p">)</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">free_space</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">use_pool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">gpu_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">gpu</span><span class="o">.</span><span class="n">use_pool</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_size_string</span><span class="p">(</span><span class="n">gpu_pool</span><span class="p">)</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">gpu</span><span class="o">.</span><span class="n">free_space</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_params</span><span class="o">.</span><span class="n">memory_pool_config</span><span class="o">.</span><span class="n">gpu</span><span class="o">.</span><span class="n">use_pool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workers_started</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_cluster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_paths</span><span class="p">)</span>

        <span class="c1"># Invalidate db metadata because of job run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_db_metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Run the job</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rpc</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_master</span><span class="o">.</span><span class="n">NewJob</span><span class="p">(</span>
            <span class="n">job_params</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grpc_timeout</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">detach</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">bulk_job_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">bulk_job_id</span>
        <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_on_job</span><span class="p">(</span><span class="n">bulk_job_id</span><span class="p">,</span> <span class="n">show_progress</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_status</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="n">job_status</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">db_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_db_metadata</span><span class="p">()</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">db_meta</span><span class="o">.</span><span class="n">bulk_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">job_name</span><span class="p">:</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span>
                <span class="s1">&#39;Internal error: job id not found after run&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_table_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">job_output_table_names</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div></div>


<div class="viewcode-block" id="start_master"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.start_master">[docs]</a><span class="k">def</span> <span class="nf">start_master</span><span class="p">(</span><span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">watchdog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">no_workers_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">new_job_retries_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Start a master server instance on this node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    port</span>
<span class="sd">      The port number to start the master on. If unspecified, it will be</span>
<span class="sd">      read from the provided Config.</span>

<span class="sd">    config</span>
<span class="sd">      The scanner Config to use. If specified, config_path is ignored.</span>

<span class="sd">    config_path : optional</span>
<span class="sd">      Path to a Scanner configuration TOML, by default assumed to be</span>
<span class="sd">      `~/.scanner/config.toml`.</span>

<span class="sd">    block : optional</span>
<span class="sd">      If true, will wait until the server is shutdown. Server will not</span>
<span class="sd">      shutdown currently unless wait_for_server_shutdown is eventually</span>
<span class="sd">      called.</span>

<span class="sd">    watchdog : optional</span>
<span class="sd">      If true, the master will shutdown after a time interval if</span>
<span class="sd">      PokeWatchdog is not called.</span>

<span class="sd">    no_workers_timeout : optional</span>
<span class="sd">      The interval after which the master will consider a job to have failed if</span>
<span class="sd">      it has no workers connected to it.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Database</span>
<span class="sd">      A cpp database instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">master_port</span>

    <span class="c1"># Load all protobuf types</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">storage_config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">master_address</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="n">start_master</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">SCRIPT_DIR</span><span class="p">,</span> <span class="n">watchdog</span><span class="p">,</span>
                                   <span class="n">no_workers_timeout</span><span class="p">,</span>
                                   <span class="n">new_job_retries_limit</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Failed to start master: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
        <span class="n">bindings</span><span class="o">.</span><span class="n">wait_for_server_shutdown</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span></div>


<div class="viewcode-block" id="start_worker"><a class="viewcode-back" href="../../api/scannerpy.html#scannerpy.database.start_worker">[docs]</a><span class="k">def</span> <span class="nf">start_worker</span><span class="p">(</span><span class="n">master_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">machine_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">watchdog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Starts a worker instance on this node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    master_address</span>
<span class="sd">      The address of the master server to connect this worker to. The expected</span>
<span class="sd">      format is &#39;0.0.0.0:5000&#39; (ip:port).</span>

<span class="sd">    machine_params</span>
<span class="sd">      Describes the resources of the machine that the worker should manage. If</span>
<span class="sd">      left unspecified, the machine resources will be inferred.</span>

<span class="sd">    config</span>
<span class="sd">      The Config object to use in creating the worker. If specified, config_path</span>
<span class="sd">      is ignored.</span>

<span class="sd">    config_path</span>
<span class="sd">      Path to a Scanner configuration TOML, by default assumed to be</span>
<span class="sd">      `~/.scanner/config.toml`.</span>

<span class="sd">    block</span>
<span class="sd">      If true, will wait until the server is shutdown. Server will not shutdown</span>
<span class="sd">      currently unless wait_for_server_shutdown is eventually called.</span>

<span class="sd">    watchdog</span>
<span class="sd">      If true, the worker will shutdown after a time interval if</span>
<span class="sd">      PokeWatchdog is not called.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    db</span>
<span class="sd">      This is for internal usage only.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Database</span>
<span class="sd">      A cpp database instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Worker always has watchdog enabled to determine when master connection</span>
    <span class="c1"># has failed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">watchdog</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Forcing worker to enable watchdog. Watchdog must be enabled to &#39;</span>
               <span class="s1">&#39;detect if worker has disconnected from master.&#39;</span><span class="p">),</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">watchdog</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">worker_port</span>

    <span class="c1"># Load all protobuf types</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="ow">or</span> <span class="n">bindings</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">storage_config</span><span class="p">,</span>
        <span class="n">config</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span>
        <span class="n">master_address</span><span class="p">)</span>
    <span class="n">machine_params</span> <span class="o">=</span> <span class="n">machine_params</span> <span class="ow">or</span> <span class="n">bindings</span><span class="o">.</span><span class="n">default_machine_params</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="n">start_worker</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">machine_params</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">SCRIPT_DIR</span><span class="p">,</span>
                                   <span class="n">watchdog</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ScannerException</span><span class="p">(</span><span class="s1">&#39;Failed to start worker: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">msg</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
        <span class="n">bindings</span><span class="o">.</span><span class="n">wait_for_server_shutdown</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!-- Copyright (c) 2018 Jeff Forcier.

     Based on original work copyright (c) 2011 Kenneth Reitz and copyright (c) 2010
     Armin Ronacher.

     Some rights reserved.

     Redistribution and use in source and binary forms of the theme, with or
     without modification, are permitted provided that the following conditions
     are met:

     * Redistributions of source code must retain the above copyright
     notice, this list of conditions and the following disclaimer.

     * Redistributions in binary form must reproduce the above
     copyright notice, this list of conditions and the following
     disclaimer in the documentation and/or other materials provided
     with the distribution.

     * The names of the contributors may not be used to endorse or
     promote products derived from this software without specific
     prior written permission.

     THIS THEME IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
     AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
     IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
     ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
     LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
     SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
     INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
     CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
     ARISING IN ANY WAY OUT OF THE USE OF THIS THEME, EVEN IF ADVISED OF THE
     POSSIBILITY OF SUCH DAMAGE.
   -->

<h1 class="logo"><a href="../../index.html">Scanner</a></h1>



<p class="blurb">Efficient Video Analysis at Scale</p>




<p style="margin-bottom: 0px">
<a href="https://github.com/scanner-research/scanner" class="gh-btn" target="_blank" style="margin-bottom: 5px; display: inline-block;"> <span class="gh-text">View on GitHub</span> </a>
<iframe src="https://ghbtns.com/github-btn.html?user=scanner-research&repo=scanner&type=star&count=true&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
<a href="https://travis-ci.org/scanner-research/scanner">
  <img
     style="margin-top:5px;"
     alt="https://secure.travis-ci.org/scanner-research/scanner.svg?branch=master"
     src="https://secure.travis-ci.org/scanner-research/scanner.svg?branch=master"
     />
</a>
</p>



<p style="padding-bottom: 1px; margin-top: 0px; margin-bottom: 20px;">
</p><!-- Copyright (c) 2018 Jeff Forcier.

     Based on original work copyright (c) 2011 Kenneth Reitz and copyright (c) 2010
     Armin Ronacher.

     Some rights reserved.

     Redistribution and use in source and binary forms of the theme, with or
     without modification, are permitted provided that the following conditions
     are met:

     * Redistributions of source code must retain the above copyright
     notice, this list of conditions and the following disclaimer.

     * Redistributions in binary form must reproduce the above
     copyright notice, this list of conditions and the following
     disclaimer in the documentation and/or other materials provided
     with the distribution.

     * The names of the contributors may not be used to endorse or
     promote products derived from this software without specific
     prior written permission.

     THIS THEME IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
     AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
     IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
     ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
     LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
     CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
     SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
     INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
     CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
     ARISING IN ANY WAY OUT OF THE USE OF THIS THEME, EVEN IF ADVISED OF THE
     POSSIBILITY OF SUCH DAMAGE.
   -->
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming-handbook.html">Programming Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">Citation &amp; About</a></li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation index</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2018, Alex Poms, Will Crichton.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
  </div>
  
  </body>
</html>